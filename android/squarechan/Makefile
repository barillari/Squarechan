.PHONY=default debug debug-emu debug-device market clean graphics

default:
	echo "say 'debug-emu' 'debug-dev' or 'market'"

# FIXME: to make the build process faster, we should not update the
# timestamp on Squarechan.scala if it hasn't changed, since it
# triggers the ultra-slow scala compiler
debug: graphics
	echo "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<!-- DO NOT EDIT THIS FILE. IT IS AUTO-GENERATED. YOUR CHANGES WILL BE LOST! \n\n\n\n\n\n\n\n\n\n\n-->" > src/main/AndroidManifest.xml
	sed 's/ANDROID_DEBUGGABLE/true/' <  src/main/AndroidManifest.xml-template | sed 's/DEBUGTAG/_debug/g' >> src/main/AndroidManifest.xml
	echo '<!-- this file is auto-generated. DO NOT EDIT. edit the makefile --><resources><string name="app_name">SQDebug</string></resources>' > src/main/res/values/genstrings.xml
	echo "/* DO NOT EDIT THIS FILE. IT IS AUTO-GENERATED. YOUR CHANGES WILL BE LOST!  \n\n\n\n\n\n\n\n\n\n\n*/" > project/build/Squarechan.scala
	sed 's/PROGUARD_OPTIONS/-dontobfuscate/' <  project/build/Squarechan.scala-template >> project/build/Squarechan.scala
	echo 'package com.squarechan.android\ntrait SQDebugState extends Object { val DEBUG = true; val HOSTNAME = "dev.squarechan.com" }' > src/main/scala/SQDebugState.scala


debug-emu: debug
	bash build.sh reinstall-emulator

debug-device: debug
	bash build.sh reinstall-device

market: graphics
	echo "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<!-- DO NOT EDIT THIS FILE. IT IS AUTO-GENERATED. YOUR CHANGES WILL BE LOST! \n\n\n\n\n\n\n\n\n\n\n-->" > src/main/AndroidManifest.xml
	echo '<!-- this file is auto-generated. DO NOT EDIT. edit the makefile --><resources><string name="app_name">Squarechan</string></resources>' > src/main/res/values/genstrings.xml
	sed 's/ANDROID_DEBUGGABLE/false/' <  src/main/AndroidManifest.xml-template  | sed 's/DEBUGTAG//g' >> src/main/AndroidManifest.xml
	echo "/* DO NOT EDIT THIS FILE. IT IS AUTO-GENERATED. YOUR CHANGES WILL BE LOST!  \n\n\n\n\n\n\n\n\n\n\n*/" > project/build/Squarechan.scala
	sed 's/PROGUARD_OPTIONS/-assumenosideeffects class android.util.Log {public static int v(...);public static int d(...);public static int w(...);public static int i(...);}/' <  project/build/Squarechan.scala-template >> project/build/Squarechan.scala
	echo 'package com.squarechan.android\ntrait SQDebugState extends Object { val DEBUG = false; val HOSTNAME = "squarechan.com" }' > src/main/scala/SQDebugState.scala
	bash build.sh prepare-market

clean:
	bash build.sh clean 
realclean:
	bash build.sh clean clean-plugins clean-lib clean-cache

graphics:
	make -C graphics

#sign:
#	jarsigner -verbose -keystore ../../squarechan-release-key.keystore ./target/scala_2.8.1/squarechan_2.8.1-0.1.apk release

# if you switch from the signed to the debug version or vice versa, you need to remove the pkg first...
remove-device:
	~/dl/android-sdk-linux_86/platform-tools/adb  -d uninstall com.squarechan.android
remove-emu:
	~/dl/android-sdk-linux_86/platform-tools/adb  -e uninstall com.squarechan.android

droid-fu:
	(cd /home/jdb/squarechan/3rdparty/droid-fu/ && mvn clean && mvn -e install -DcopyTo=/home/jdb/squarechan/android/squarechan/lib)